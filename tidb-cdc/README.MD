README â€“ TiDB CDC Full Pipeline (Kafka â†’ Node â†’ Elasticsearch â†’ Grafana)
ğŸš€ Overview

This project provides a complete real-time Change Data Capture (CDC) pipeline built on TiDB, streaming database changes into Kafka, processing them via a Node.js CDC Consumer, and indexing results into Elasticsearch, with full monitoring through Prometheus and Grafana.

Supported CDC operations:

INSERT

UPDATE

DELETE

DDL events (ignored by consumer, counted as invalid_format)

This setup is ideal for:

Real-time analytics

Audit logs

Search indexing

Monitoring DB activity

ğŸ“¦ Architecture
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  TiDB    â”‚
          â”‚ (MySQL   â”‚
          â”‚ compatible) 
          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                â”‚  (TiCDC)
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   TiDB CDC  â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â”‚ sink: canal-json
                â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚     Kafka        â”‚
       â”‚ topic: tidb-cdc  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ Node.js Consumer â”‚
       â”‚  - Validates CDC â”‚
       â”‚  - Parses events â”‚
       â”‚  - Indexes ES    â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  Elasticsearch      â”‚
      â”‚ index: tidb-cdcâ€¦   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Monitoring:
  - Node.js exposes /metrics â†’ Prometheus
  - Grafana visualizes Prometheus + ES dashboards

ğŸ— Project Structure
.
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ node-consumer/         # Node.js CDC processor
â”œâ”€â”€ prometheus/            # Prometheus config
â”œâ”€â”€ grafana/               # Dashboards + datasources
â”œâ”€â”€ sql/                   # schema.sql + seed.sql
â”œâ”€â”€ run_test.sh            # CDC automatic test suite
â””â”€â”€ QUICK-START.sh         # One-command startup

â–¶ï¸ How to Start
1ï¸âƒ£ Start all services
docker compose up -d

2ï¸âƒ£ Verify TiDB Connection
docker run -it --rm --network=tidb-cdc-v2-final-working_tidb-net mysql:8 \
  mysql -h tidb-server -P 4000 -u root

3ï¸âƒ£ Run the CDC Test Suite
./run_test.sh


This script performs:

Product inserts

Price updates

User creation

Order creation

Order updates

Deletes

Batch operations

ğŸ” Checking Results
Elasticsearch
curl -X GET "localhost:9200/tidb-cdc-events/_search?pretty"

Prometheus

ğŸ‘‰ http://localhost:9091

Grafana

ğŸ‘‰ http://localhost:3001

User: admin
Pass: admin

Dashboards are auto-provisioned.

ğŸ“Š Metrics Exposed
Node.js Consumer Metrics
Metric	Description
tidb_cdc_operations_total	Counters per table & op
tidb_cdc_processing_duration_seconds	Processing latency
kafka_messages_processed_total	Success / invalid
elasticsearch_operations_total	Indexed docs
Node.js process metrics	CPU, memory, heap, event loop

These appear automatically in Prometheus.

ğŸ“ˆ Grafana Dashboards

Preloaded dashboard includes:

CDC Operations over time

Operation rate (per table)

Total inserts / updates

Raw CDC event table (from Elasticsearch)

Node.js performance stats

ğŸ›  Development
Rebuild Node.js Consumer
docker compose build node-consumer
docker compose up -d node-consumer

Reset Everything
docker compose down -v
docker compose up -d

âœ”ï¸ Requirements

Docker + Docker Compose

At least 4 GB RAM (Elasticsearch requires it)

Linux recommended (Windows WSL2 works)
